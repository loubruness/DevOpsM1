version: '3.9'

services:
  jenkins-master:
    build:
      context: .
      dockerfile: Dockerfile
    image: myjenkins-master
    container_name: jenkins-master
    restart: on-failure
    networks:
      - jenkins
    environment:
      - SLACK_SECRET_TOKEN=xoxb-7350845836756-7348539158866-9RTJTHRJl4EWWCVFSRFZF56z
    volumes:
      - jenkins-data:/var/jenkins_home
      - jenkins-docker-certs:/certs/client:ro
      - /var/run/docker.sock:/var/run/docker.sock
    ports:
      - "8080:8080"
      - "50000:50000"

  jenkins-agent:
    build:
      context: .
      dockerfile: Dockerfile-jenkins-agent
    image: jenkins-agent-image
    container_name: jenkins-agent
    ports:
      - "22:22"
    environment:
      - JENKINS_AGENT_SSH_PUBKEY=ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDV/9LSE2plFt0H3AFMlRPKlS0dXEnBeq8lHl/jy/yHxu1SsFoUwYTLpbwoOmiWI1UxF7R/KDU4sy7mNJsS+Q1UMsAI5mdUI88+n3SpL3VDrsj5pp7PjQfLu2zQNMB4tJROr+0Pj9Fu977m+IdzyIBcyQd22WG6SQMYOahrnvL2N3INx+F/4pE7RjCarv0BryFfk85kVkRtFil3+Bd2rV9XZK3rGhMcRB1ovortTWQLFkiyEEl0TP+TCI6+ikXVmsXrNoY3oj5YENSiyw1Tof9n9rtq+vhmVlpH8KGkj7tJUgRM1iIP+f62jzrk8iMaZE8v40xcoPTF5RO2WTWQ4yGoVpeNtQewJCN3i/qR2HxzpywO/xhOCq35xAVkPSTdARHnzUHApcxHRNe6FYnkgdFPKgvRn4hKf4hWhbu2wxP62x8rTDkXwPX23jYNSuLBZIYDSNlkpSdjSWwaw/X80VislIsgNs+GYREddrQHeHXvgL27DV5IFjNW3AWr8DW6M5U= pauli@DESKTOP-PRG4B1I
    networks:
      - jenkins
    restart: always
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock

  final-server:
    image: ubuntu:latest
    container_name: final-server
    volumes:
      - final_server_deploy:/var/www/html
    depends_on:
      - jenkins-master
    networks:
      - jenkins

  registry:
    image: registry:2
    container_name: private_registry
    ports:
      - "5001:5000"
    volumes:
      - registry_data:/var/lib/registry
    restart: always
    networks:
      - jenkins

networks:
  jenkins:
    driver: bridge

volumes:
  jenkins-data:
  jenkins-docker-certs:
  final_server_deploy:
  agent_workdir:
  registry_data:
